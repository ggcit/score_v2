<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>정성적 평가 채점 집계표</title>
    <style>
        @page {
            size: A4;
            margin: 0; /* PDF 변환 시 여백 제거 (CSS로 제어) */
        }
        body {
            font-family: '맑은 고딕', sans-serif;
            margin: 0 auto;
            width: 210mm;
            /* min-height: 297mm; 제거하여 불필요한 빈 페이지 방지 */
            box-sizing: border-box;
            padding: 15mm; /* 실제 내용 여백 */
        }
        h1 {
            text-align: center;
            font-size: 24px;
            margin-top: 0;
            margin-bottom: 20px;
        }
        .project-info {
            font-size: 15px;
            margin-bottom: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            border-top: 2px solid #000;
            border-bottom: 1px solid #000;
            margin-bottom: 15px;
            table-layout: fixed;
        }
        th, td {
            border: 1px solid #000;
            padding: 5px;
            text-align: center;
            font-size: 14px;
            vertical-align: middle;
            height: 30px;
        }
        th {
            background-color: #fff;
            font-weight: bold;
            height: 35px;
        }
        .footer-info {
            margin-top: 20px;
            font-size: 14px;
            line-height: 1.6;
        }
        .date-row {
            text-align: center;
            margin: 30px 0;
            font-size: 16px;
        }
        .sign-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 0 10px;
            align-items: flex-end;
            font-size: 15px;
        }
        .sign-label {
            width: 280px;
        }
        .sign-name-wrapper {
            display: flex;
            align-items: center;
            width: 300px;
            justify-content: flex-end;
        }
        .sign-name {
            text-align: left;
            margin-right: 10px;
        }
        .sign-space {
            text-align: right;
            white-space: nowrap;
        }
        .sub-text {
            font-size: 11px;
            display: block;
            margin-top: 2px;
        }
        @media print {
            body { width: 100%; padding: 10mm; height: auto; }
            .no-print { display: none; }
        }
        .no-print-btn {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<div class="no-print" style="position: fixed; top: 20px; right: 20px; display: flex; gap: 10px;">
    <button class="no-print-btn" onclick="savePDF()" style="position: static; background-color: #28a745;">PDF 저장</button>
    <button class="no-print-btn" onclick="window.print()" style="position: static;">인쇄하기</button>
    <button class="no-print-btn" onclick="resetData()" style="position: static; background-color: #dc3545;">데이터 초기화</button>
</div>

<h1>정성적 평가 채점 집계표</h1>

<div class="project-info">
    □ 사업명 : 2026년 경기도의회 의정 정보시스템 통합 운영 및 유지관리
</div>

<table id="summaryTable">
    <thead>
        <tr>
            <th rowspan="2" style="width: 25%;">평가위원</th>
            <th colspan="2">평점</th>
        </tr>
        <tr>
            <th>A사</th>
            <th>B사</th>
        </tr>
    </thead>
    <tbody id="tableBody">
        <!-- 자바스크립트로 동적 생성 -->
    </tbody>
    <tbody id="tableFooter">
        <tr style="font-weight: bold; background-color: #f9f9f9;">
            <td>계</td>
            <td id="sumA">0.00</td>
            <td id="sumB">0.00</td>
        </tr>
        <tr>
            <td>제외점수<br><span style="font-size: 11px;">(최고/최저)</span></td>
            <td id="excludedA">0.00<br><span class="sub-text">(0.00/0.00)</span></td>
            <td id="excludedB">0.00<br><span class="sub-text">(0.00/0.00)</span></td>
        </tr>
        <tr style="font-weight: bold; background-color: #f0f0f0;">
            <td>평균</td>
            <td id="avgA">0.00</td>
            <td id="avgB">0.00</td>
        </tr>
    </tbody>
</table>

<div class="footer-info">
    * 최상위와 최하위를 제외한 후 평균 산정하며 최상위와 최하위 평점이 2개 이상인 경우에는 1개씩만을 제외
</div>

<div class="date-row" id="currentDate">
    2025년 12월 4일
</div>

<div class="sign-row">
    <span class="sign-label">작 성 자 : 지방전산주사</span>
    <div class="sign-name-wrapper">
        <span class="sign-name">성 명 ____________________</span>
        <span class="sign-space">(서명)</span>
    </div>
</div>
<div class="sign-row">
    <span class="sign-label">검 토 자 : AI의정혁신팀장(代)</span>
    <div class="sign-name-wrapper">
        <span class="sign-name">성 명 ____________________</span>
        <span class="sign-space">(서명)</span>
    </div>
</div>
<div class="sign-row">
    <span class="sign-label">확 인 자 : 제안서 평가위원회 위원장</span>
    <div class="sign-name-wrapper">
        <span class="sign-name">성 명 ____________________</span>
        <span class="sign-space">(서명)</span>
    </div>
</div>

<script>
// Supabase 설정
const SUPABASE_URL = 'https://tgwbbfhfgzgmirbmvrfm.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRnd2JiZmhmZ3pnbWlyYm12cmZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2NjkxODQsImV4cCI6MjA3OTI0NTE4NH0.2R3P1tNnkSPB8w4Qpu7UeLt47ka_gz-gJLlvMxkDFVc';
const TABLE_NAME = 'evaluation_results';

// Supabase 클라이언트 초기화
const memoryStorage = {
  getItem: (key) => null,
  setItem: (key, value) => {},
  removeItem: (key) => {},
};

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
    auth: {
        persistSession: false,
        autoRefreshToken: false,
        detectSessionInUrl: false,
        storage: memoryStorage
    }
});

// 오늘 날짜 표시
const today = new Date();
const dateStr = `${today.getFullYear()}년 ${today.getMonth() + 1}월 ${today.getDate()}일`;
document.getElementById('currentDate').textContent = dateStr;

// 데이터 로드 및 렌더링
async function loadAndRender() {
    try {
        // Supabase에서 데이터 가져오기
        const { data, error } = await supabaseClient
            .from(TABLE_NAME)
            .select('evaluator, proposal_name, total_score')
            .order('evaluator', { ascending: true });

        if (error) throw error;

        // 데이터 가공 (Pivot)
        const scoresByEvaluator = {};
        data.forEach(row => {
            if (!scoresByEvaluator[row.evaluator]) {
                scoresByEvaluator[row.evaluator] = { A: 0, B: 0 };
            }
            const pName = row.proposal_name.toUpperCase();
            if (pName === 'A' || pName === 'B') {
                scoresByEvaluator[row.evaluator][pName] = parseFloat(row.total_score) || 0;
            }
        });

        const evaluators = Object.keys(scoresByEvaluator).sort();
        const tableBody = document.getElementById('tableBody');
        tableBody.innerHTML = '';

        const allScoresA = [];
        const allScoresB = [];

        // 행 생성
        evaluators.forEach(evaluator => {
            const scores = scoresByEvaluator[evaluator];
            const tr = document.createElement('tr');
            
            // 데이터 수집
            allScoresA.push(scores.A);
            allScoresB.push(scores.B);

            tr.innerHTML = `
                <td>${evaluator}</td>
                <td>${scores.A > 0 ? scores.A.toFixed(2) : ''}</td>
                <td>${scores.B > 0 ? scores.B.toFixed(2) : ''}</td>
            `;
            tableBody.appendChild(tr);
        });

        // 빈 행 채우기 (최소 10줄 정도 모양 유지를 위해)
        // 여백 조절을 위해 최소 행 개수를 10개 -> 8개로 조정하여 공간 확보
        const minRows = 8;
        const emptyRows = minRows - evaluators.length;
        for (let i = 0; i < emptyRows; i++) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>&nbsp;</td>
                <td></td>
                <td></td>
            `;
            tableBody.appendChild(tr);
        }

        // 통계 계산 함수
        function calculateStats(scores) {
            const validScores = scores.filter(s => s > 0);

            if (validScores.length === 0) return { sum: 0, max: 0, min: 0, avg: 0 };

            const sum = validScores.reduce((a, b) => a + b, 0);
            
            // 평가위원이 3명 미만이면 제외 없이 평균
            if (validScores.length < 3) {
                return {
                    sum: sum,
                    max: Math.max(...validScores),
                    min: Math.min(...validScores),
                    avg: sum / validScores.length
                };
            }

            const max = Math.max(...validScores);
            const min = Math.min(...validScores);
            
            const excludedSum = sum - max - min;
            const avg = excludedSum / (validScores.length - 2);

            return { sum, max, min, avg };
        }

        const statsA = calculateStats(allScoresA);
        const statsB = calculateStats(allScoresB);

        // 결과 표시
        document.getElementById('sumA').textContent = statsA.sum.toFixed(2);
        document.getElementById('sumB').textContent = statsB.sum.toFixed(2);

        document.getElementById('excludedA').innerHTML = `
            ${(statsA.max + statsA.min).toFixed(2)}<br>
            <span class="sub-text">(${statsA.max.toFixed(2)}/${statsA.min.toFixed(2)})</span>
        `;
        document.getElementById('excludedB').innerHTML = `
            ${(statsB.max + statsB.min).toFixed(2)}<br>
            <span class="sub-text">(${statsB.max.toFixed(2)}/${statsB.min.toFixed(2)})</span>
        `;

        document.getElementById('avgA').textContent = statsA.avg.toFixed(2);
        document.getElementById('avgB').textContent = statsB.avg.toFixed(2);

    } catch (e) {
        console.error('데이터 로드 실패:', e);
        alert('데이터를 불러오는 중 오류가 발생했습니다.');
    }
}

window.onload = loadAndRender;

function savePDF() {
    const element = document.body;
    const opt = {
        margin: 0,
        filename: '정성적_평가_채점_집계표.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, logging: false, letterRendering: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait', compress: true },
        pagebreak: { mode: 'avoid-all' }
    };

    // 버튼 숨기기
    const buttons = document.querySelector('.no-print');
    buttons.style.display = 'none';

    html2pdf().set(opt).from(element).save().then(() => {
        // 버튼 다시 보이기
        buttons.style.display = 'flex';
    });
}

async function resetData() {
    if (confirm('경고: 저장된 모든 채점 데이터가 영구적으로 삭제됩니다.\n정말로 초기화하시겠습니까?')) {
        try {
            // 테이블의 모든 데이터 삭제 (id가 -1보다 큰 모든 항목)
            const { error } = await supabaseClient
                .from(TABLE_NAME)
                .delete()
                .gt('id', -1);

            if (error) throw error;

            alert('모든 데이터가 삭제되었습니다.');
            loadAndRender(); // 화면 새로고침
        } catch (e) {
            console.error('데이터 삭제 오류:', e);
            alert('데이터 삭제 중 오류가 발생했습니다.\n' + e.message);
        }
    }
}
</script>

</body>
</html>